#!/usr/bin/perl

use strict;
use warnings;
use SOAP::Lite;
#use SOAP::Lite +trace => 'debug';
use Passwd::Keyring::Gnome;

our $VERSION = '0.01';

my $destination = shift;
$destination =~ s/^tel://;

my $url      = 'https://example.org/';
my ($app) = $0 =~ m{.*/(.*)$};

my $keyring = Passwd::Keyring::Gnome->new(
    app   => $app,
    group => "default",
);

my $username = $ENV{USER};

my $password = $keyring->get_password( $username, $app );
unless ($password) {
    $password = get_password( $username, $keyring, $app );
}

my $soap = SOAP::Lite->new();

$soap->proxy( "$url//webdialer/services/WebdialerSoapService70",
    ssl_opts => [ SSL_verify_mode => 0 ] );
$soap->service("$url/webdialer/wsdl/wd70.wsdl");

$soap->readable(1);

my $profile = $soap->getProfileDetailSoap(
    SOAP::Data->name('in0')->type('urn:Credential')->value(
        \SOAP::Data->value(
            SOAP::Data->name( 'userID'   => $username ),
            SOAP::Data->name( 'password' => $password ),
        )
    )
)->result;

my $device = $profile->{deviceInfoListDetail}->[0]->{deviceName};
my $line = $profile->{deviceInfoListDetail}->[0]->{lines}->[0];

use Data::Dumper;

my $call = $soap->makeCallSoap(
    SOAP::Data->name('in0')->type('urn:Credential')->value(
        \SOAP::Data->value(
            SOAP::Data->name( 'userID'   => $username ),
            SOAP::Data->name( 'password' => $password ),
        )
    ),
    SOAP::Data->name('in1')->type('xsd:string')->value($destination),
    SOAP::Data->name('in2')->type('urn:UserProfile')->value(
        \SOAP::Data->value(
            SOAP::Data->name( 'user'   => $username ),
            SOAP::Data->name( 'deviceName' => $device ),
            SOAP::Data->name( 'lineNumber' => $line ),
        )
    ),

);

sub get_password {
    my ( $username, $keyring ) = @_;
    my $password = qx(zenity --password --title "Password for Cisco Webdialer");
    chomp($password);
    my $rc = $? >> 8;
    if ( $rc == 0 ) {
        $keyring->set_password( $username, $password, $app );
        return $password;
    }
    return;
}
